#!/bin/ksh

### reads zonal means in h0zm, h3zm and creates global means from all available years
#
# Define environment variables, i.e.:
#   export caseid=b40.rcp4_5.2deg.wcm.carma.bc5tgIP.avg
# Optional history tape (default h0):
#   export hnum=h3

echo " "
echo globavg

if  [ -n "$caseid" ] ; then

  export machine=`hostname`

  if [ ! -n "$rootpath" ] ; then

    if [[ $machine =~ 'yslogin' ]];then
#      rootpath='/glade/p/cesm/wawg/waccm'
      rootpath='/glade/scratch/mmills/archive'
    fi

    if [[ $machine =~ 'geyser' ]];then
      rootpath='/glade/p/cesm/wawg/mmills/run'
    fi

    if [[ $machine =~ 'caldera' ]];then
      rootpath='/glade/p/cesm/wawg/mmills/run'
    fi

    if [[ $machine =~ 'mirage' ]];then
      rootpath='/CESM/wawg/runs'
    fi

    if [[ $machine = 'modeling1' ]];then
      rootpath='/data4/mmills'
    fi

    if [[ $machine =~ 'lfe' ]];then
      rootpath='/lou/s2m/mjmills2/csm'
    fi

    if [[ $machine = 'cmip5' ]];then
      rootpath='/data/waccm'
    #  rootpath='/data/ccsm4'
    fi

    if [[ $OSTYPE = 'darwin' ]];then
      rootpath='/Volumes/Data/Models/waccm/run/carma-soot'
    fi
    
  fi

  if [ ! -n "$runname" ] ; then
    runname=''
  fi

  if [ ! -n "$hnum" ] ; then
    hnum='h0'
  fi

  if [ ! -n "$htype" ] ; then
    htype=''
  fi

  zmdir=$rootpath'/'$caseid'/'$runname'/atm/proc/'$hnum'zm'$htype
  gmdir=$rootpath'/'$caseid'/'$runname'/atm/proc/'$hnum'gm'$htype
  tmdir=$rootpath'/'$caseid'/'$runname'/atm/proc/'$hnum'tm'$htype

  if [[ $machine = 'lou' ]];then
    rootpath=$HOME'/csm'
    zmdir=$rootpath'/'$caseid'/atm/'$hnum'zm'
    gmdir=$rootpath'/'$caseid'/atm/'$hnum'gm'
  fi

  mkdir -p $gmdir
  mkdir -p $tmdir

  avgfile=$gmdir'/'$caseid'.cam.'$hnum'.globavg.nc'
  tmpfile=$gmdir'/zmtmp.nc'

  echo " "
  echo "avgfile= $avgfile"
  ncfiles=$zmdir'/*.cam'*'.'$hnum'zm.*.nc'
  echo " "
  echo "ncrcat -O $ncfiles $tmpfile"
  ncrcat -O $ncfiles $tmpfile
    
  echo " "
  echo "ncwa -O -I -a lat -w gw -x -v nlon,wnummax $tmpfile $avgfile"
  ncwa -O -I -a lat -w gw -x -v nlon,wnummax $tmpfile $avgfile
    
  avgfile=$tmdir'/'$caseid'.cam.'$hnum'.tropicsavg.nc'
  echo " "
  echo "avgfile= $avgfile"
    
  echo " "
  echo "ncwa -O -I -a lat -w gw -d lat,-23.4378,23.4378 -x -v nlon,wnummax $tmpfile $avgfile"
  ncwa -O -I -a lat -w gw -d lat,-23.4378,23.4378 -x -v nlon,wnummax $tmpfile $avgfile
    
  avgfile=$gmdir'/'$caseid'.cam.'$hnum'.NHavg.nc'
  echo " "
  echo "avgfile= $avgfile"
    
  echo " "
  echo "ncwa -O -I -a lat -w gw -d lat,0.0,90.0 -x -v nlon,wnummax $tmpfile $avgfile"
  ncwa -O -I -a lat -w gw -d lat,0.0,90.0 -x -v nlon,wnummax $tmpfile $avgfile
    
  avgfile=$gmdir'/'$caseid'.cam.'$hnum'.SHavg.nc'
  echo " "
  echo "avgfile= $avgfile"
    
  echo " "
  echo "ncwa -O -I -a lat -w gw -d lat,-90.0,0.0 -x -v nlon,wnummax $tmpfile $avgfile"
  ncwa -O -I -a lat -w gw -d lat,-90.0,0.0 -x -v nlon,wnummax $tmpfile $avgfile
    
  echo " "
  echo "rm $tmpfile"
  rm $tmpfile
else
  echo "caseid is not set, i.e.:"
  echo " setenv caseid b40.rcp4_5.2deg.wcm.carma.bc5tgIP.avg"
fi


